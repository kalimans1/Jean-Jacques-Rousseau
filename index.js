const { Client, GatewayIntentBits, EmbedBuilder, ActionRowBuilder, ButtonBuilder, ButtonStyle } = require('discord.js');
const fs = require('fs');
const path = require('path');

const getLogTime = () => {
    const now = new Date();
    return `${now.toLocaleDateString()} ${now.toLocaleTimeString()}`;
};

const sentUsers = new Set();
let tokens = [];
let currentTokenIndex = 0;
let config = {}; 

const CONFIG_FILE = 'config.json';

function loadConfig() {
    try {
        const data = fs.readFileSync(CONFIG_FILE, 'utf8');
        config = JSON.parse(data);
        console.log(`‚úÖ ${getLogTime()} - ${CONFIG_FILE} ba≈üarƒ±yla y√ºklendi.`); 
    } catch (err) {
        if (err.code === 'ENOENT') {
            console.error(`‚ùå ${getLogTime()} - Hata: ${CONFIG_FILE} dosyasƒ± bulunamadƒ±. L√ºtfen aynƒ± dizinde '${CONFIG_FILE}' adƒ±nda bir dosya olu≈üturun.`); 
        } else if (err instanceof SyntaxError) {
            console.error(`‚ùå ${getLogTime()} - Hata: ${CONFIG_FILE} dosyasƒ± ge√ßersiz JSON formatƒ±nda: ${err.message}`); 
        } else {
            console.error(`‚ùå ${getLogTime()} - Hata: ${CONFIG_FILE} dosyasƒ± okunamadƒ±: ${err.message}`); 
        }
        process.exit(1);
    }
}


function loadTokens() {
    let tokensFilePath = config.botTokenFile || 'tokens.txt'; 
    try {
        const data = fs.readFileSync(tokensFilePath, 'utf8');
        tokens = data.split('\n').map(token => token.trim()).filter(token => token.length > 0);
        if (tokens.length === 0) {
            console.error(`‚ùå ${getLogTime()} - Hata: ${tokensFilePath} dosyasƒ±nda hi√ß token bulunamadƒ±.`); 
            process.exit(1);
        }
        console.log(`‚úÖ ${getLogTime()} - ${tokens.length} adet token ${tokensFilePath} dosyasƒ±ndan y√ºklendi.`);
    } catch (err) {
        if (err.code === 'ENOENT') {
            console.error(`‚ùå ${getLogTime()} - Hata: ${tokensFilePath} dosyasƒ± bulunamadƒ±. L√ºtfen aynƒ± dizinde '${tokensFilePath}' adƒ±nda bir dosya olu≈üturun ve i√ßine tokenlerinizi yazƒ±n.`); 
        } else {
            console.error(`‚ùå ${getLogTime()} - Hata: ${tokensFilePath} dosyasƒ± okunamadƒ±: ${err.message}`); 
        }
        process.exit(1);
    }
}

function moveTokenToTrash(tokenToMove) {
    const tokensFilePath = config.botTokenFile || 'tokens.txt';
    const trashTokensFilePath = config.trashTokenFile || 'trashtokens.txt';

    console.log(`‚ö†Ô∏è ${getLogTime()} - Token '${tokenToMove}' ge√ßersiz, spam olarak i≈üaretlendi veya kullanƒ±lamƒ±yor.`); 
    console.log(`‚ÑπÔ∏è ${getLogTime()} - ${tokensFilePath} dosyasƒ±ndan kaldƒ±rƒ±lƒ±yor ve ${trashTokensFilePath} dosyasƒ±na ta≈üƒ±nƒ±yor.`); 

    tokens = tokens.filter(t => t !== tokenToMove);
    fs.writeFileSync(tokensFilePath, tokens.join('\n') + (tokens.length > 0 ? '\n' : ''), 'utf8');

    fs.appendFileSync(trashTokensFilePath, tokenToMove + '\n', 'utf8');

    console.log(`‚úÖ ${getLogTime()} - Token ba≈üarƒ±yla ta≈üƒ±ndƒ±.`); 
}



async function loginAndRunBot(token) {
    const client = new Client({
        intents: [
            GatewayIntentBits.Guilds,
            GatewayIntentBits.GuildMembers,
            GatewayIntentBits.DirectMessages,
            GatewayIntentBits.MessageContent,
        ],
    });

    client.on('ready', async () => {
        console.log(`‚úÖ ${getLogTime()} - Bot '${client.user.tag}' olarak giri≈ü yaptƒ±.`); 
    });

    client.on('guildCreate', async guild => {
        console.log(`‚úÖ ${getLogTime()} - Bot yeni bir sunucuya katƒ±ldƒ±: ${guild.name} (${guild.id})`); 
        await sendDmToGuildMembers(guild, client.token);
    });

    client.on('error', error => {
        console.error(`‚ùå ${getLogTime()} - Bot genel bir API hatasƒ± yakaladƒ±: ${error.message}`); 

        const currentToken = client.token;

        if (error.message.includes('An invalid token was provided') || error.httpStatus === 401) {
            console.error(`‚ùå ${getLogTime()} - Hata: Ge√ßersiz token saƒülandƒ±. Bir sonraki tokene ge√ßiliyor.`); 
            moveTokenToTrash(currentToken);
            switchToNextToken();
        } else if (error.message.includes('Rate limit exceeded') || error.httpStatus === 429) {
            console.error(`‚ùå ${getLogTime()} - Hata: Discord API hƒ±z limiti a≈üƒ±ldƒ± (429). Bir sonraki tokene ge√ßiliyor.`); 
            switchToNextToken();
        } else if (error.message.includes('Bot flagged as spam') || (error.code && (error.code === 10003 || error.code === 50007))) {
            console.error(`‚ùå ${getLogTime()} - Bot spam olarak i≈üaretlenmi≈ü veya DM engellenmi≈ü olabilir. Bir sonraki tokene ge√ßiliyor.`); 
            moveTokenToTrash(currentToken);
            switchToNextToken();
        } else {
            console.error(`‚ùå ${getLogTime()} - Bilinmeyen bir hata olu≈ütu. Bir sonraki tokene ge√ßiliyor.`); 
            switchToNextToken();
        }
    });

    try {
        await client.login(token);
    } catch (error) {
        console.error(`‚ùå ${getLogTime()} - Giri≈ü hatasƒ± (Token: ${token}): ${error.message}`); 

        if (error.message.includes('An invalid token was provided') || error.code === 'TOKEN_INVALID' || error.httpStatus === 401) {
            console.error(`‚ùå ${getLogTime()} - Hata: Ge√ßersiz token saƒülandƒ±. Bir sonraki tokene ge√ßiliyor.`); 
            moveTokenToTrash(token);
            switchToNextToken();
        } else {
            console.error(`‚ùå ${getLogTime()} - Bilinmeyen bir giri≈ü hatasƒ±. Bir sonraki tokene ge√ßiliyor.`);
            switchToNextToken();
        }
    }
}


async function sendDmToGuildMembers(guild, currentBotToken) {
    const dmConfig = config.dmMessage;
    if (!dmConfig) {
        console.error(`‚ùå ${getLogTime()} - Hata: config.json i√ßinde 'dmMessage' ayarlarƒ± bulunamadƒ±.`); 
        return;
    }

    try {
        console.log(`üîÑ  ${guild.name} (${guild.id}) sunucusu i√ßin √ºyeler √ßekiliyor...`); 
        const members = await guild.members.fetch().catch(fetchErr => {
            console.error(`‚ùå ${getLogTime()} - ${guild.name} (${guild.id}) sunucusunun √ºyelerini getirirken HATA OLU≈ûTU!`); 
            console.error(`‚ùå ${getLogTime()} - Hata Mesajƒ±: ${fetchErr.message}`); 
            console.error(`‚ùå ${getLogTime()} - Hata Kodu: ${fetchErr.code || 'Yok'}`); 
            console.error(`‚ùå ${getLogTime()} - Tam Hata Objeleri:`, fetchErr);

            if (fetchErr.code === 50001) {
                console.error(`‚ö†Ô∏è ${getLogTime()} - Botun sunucuya eri≈üim veya √ºye okuma yetkisi yok. Bir sonraki tokene ge√ßilmiyor.`); 
            } else if (fetchErr.code === 10003) {
                console.error(`‚ö†Ô∏è ${getLogTime()} - Sunucuya eri≈üim saƒülanamadƒ±. Sunucu kaldƒ±rƒ±lmƒ±≈ü olabilir.`);
            } else {
                console.error(`‚ùå ${getLogTime()} - Beklenmeyen bir √ºye √ßekme hatasƒ±. Bir sonraki tokene ge√ßilmiyor.`); 
            }
            throw fetchErr;
        });
        console.log(`‚úÖ${guild.name} sunucusunun √ºyeleri ba≈üarƒ±yla √ßekildi. Toplam √ºye: ${members.size}`); 

        const nonBotMembers = members.filter(member => !member.user.bot);
        const totalNonBotMembers = nonBotMembers.size;
        let dmSentInGuildCount = 0;


        for (const member of nonBotMembers.values()) {
            if (member.user.bot) continue;

            if (sentUsers.has(member.user.id)) {
                console.log(`‚ÑπÔ∏è ${getLogTime()} - ${member.user.tag} (${member.user.id}) adlƒ± kullanƒ±cƒ±ya daha √∂nce mesaj g√∂nderildi, atlanƒ±yor.`); 
                continue;
            }

            let finalNormalMessage = dmConfig.normalText
                .replace(/<@\[USER_ID\]>/g, `<@${member.user.id}>`)
                .replace(/@\[USERNAME\]/g, `@${member.user.username}`);

            const embed = new EmbedBuilder()
                .setColor(dmConfig.embed.color || 0x0099FF)
                .setTitle(dmConfig.embed.title)
                .setURL(dmConfig.embed.url);

            if (dmConfig.embed.description) {
                embed.setDescription(dmConfig.embed.description);
            }
            if (dmConfig.embed.author) {
                embed.setAuthor({
                    name: dmConfig.embed.author.name,
                    iconURL: dmConfig.embed.author.iconURL,
                    url: dmConfig.embed.author.url
                });
            }
            if (dmConfig.embed.thumbnailURL) {
                embed.setThumbnail(dmConfig.embed.thumbnailURL);
            }
            if (dmConfig.embed.imageURL) {
                embed.setImage(dmConfig.embed.imageURL);
            }
            if (dmConfig.embed.timestamp === true) {
                embed.setTimestamp();
            } else {
                if (dmConfig.embed.timestamp !== false) {
                    embed.setTimestamp();
                }
            }

            if (dmConfig.embed.fields && Array.isArray(dmConfig.embed.fields)) {
                for (const field of dmConfig.embed.fields) {
                    let fieldName = field.name
                        .replace(/<@\[USER_ID\]>/g, `<@${member.user.id}>`)
                        .replace(/@\[USERNAME\]/g, `@${member.user.username}`);

                    let fieldValue = field.value
                        .replace(/<@\[USER_ID\]>/g, `<@${member.user.id}>`)
                        .replace(/@\[USERNAME\]/g, `@${member.user.username}`);

                    if (field.dynamicTimestamp) {
                        const now = new Date();
                        const offsetMinutes = field.timestampOffsetMinutes !== undefined ? field.timestampOffsetMinutes : 0;
                        const targetTime = new Date(now.getTime() + offsetMinutes * 60 * 1000);
                        const discordTimestampFormat = field.timestampFormat || 'f';

                        fieldValue = `<t:${Math.floor(targetTime.getTime() / 1000)}:${discordTimestampFormat}>`;
                    }

                    embed.addFields({ name: fieldName, value: fieldValue, inline: field.inline || false });
                }
            }
            if (dmConfig.embed.footer) {
                embed.setFooter({
                    text: dmConfig.embed.footer.text,
                    iconURL: dmConfig.embed.footer.iconURL
                });
            }

            const button = new ButtonBuilder()
                .setLabel(dmConfig.button.label)
                .setURL(dmConfig.button.url)
                .setStyle(ButtonStyle.Link);

            const actionRow = new ActionRowBuilder().addComponents(button);

            try {
                await member.send({
                    content: finalNormalMessage,
                    embeds: [embed],
                    components: [actionRow]
                });
                dmSentInGuildCount++;
                console.log(`‚úÖ ${member.user.tag}  adlƒ± kullanƒ±cƒ±ya DM g√∂nderildi. (${dmSentInGuildCount}/${totalNonBotMembers})`); 
                sentUsers.add(member.user.id);
                await new Promise(resolve => setTimeout(resolve, 500));
            } catch (dmError) {
                if (dmError.code === 50007) {
                    console.log(`‚ö†Ô∏è ${getLogTime()} - ${member.user.tag} (${member.user.id}) adlƒ± kullanƒ±cƒ±nƒ±n DM'leri kapalƒ± veya engelledi.`); 
                } else if (dmError.message.includes('Rate limit exceeded') || dmError.code === 429) {
                    console.error(`‚ùå ${getLogTime()} - Hata: DM g√∂nderirken hƒ±z limiti a≈üƒ±ldƒ± (429). Mevcut tokeni √ß√∂pe ta≈üƒ±nƒ±yor ve bir sonraki tokene ge√ßiliyor.`); 
                    moveTokenToTrash(currentBotToken);
                    return;
                } else if (dmError.message.includes('Bot flagged as spam') || (dmError.code && dmError.code !== 50007)) {
                    console.error(`‚ùå ${getLogTime()} - Bot DM g√∂nderirken spam olarak i≈üaretlenmi≈ü veya beklenmeyen bir API hatasƒ± olu≈ütu: ${dmError.message}. Mevcut tokeni √ß√∂pe ta≈üƒ±nƒ±yor ve bir sonraki tokene ge√ßiliyor.`); 
                    console.error(`‚ùå ${getLogTime()} - Tam DM Hatasƒ± Objeleri:`, dmError); 
                    moveTokenToTrash(currentBotToken);
                    switchToNextToken();
                    return;
                } else {
                    console.error(`‚ùå ${getLogTime()} - ${member.user.tag} (${member.user.id}) adlƒ± kullanƒ±cƒ±ya DM g√∂nderilirken beklenmeyen bir hata olu≈ütu: ${dmError.message}`); 
                    console.error(`‚ùå ${getLogTime()} - Tam DM Hatasƒ± Objeleri:`, dmError); 
                }
            }
        }
    } catch (fetchError) {
        console.error(`‚ùå ${getLogTime()} - ${guild.name} sunucusunun √ºyelerini √ßekme veya i≈üleme sƒ±rasƒ±nda KRƒ∞Tƒ∞K bir hata olu≈ütu: ${fetchError.message}`); 
        console.error(`‚ùå ${getLogTime()} - Tam Kritik Hata Objeleri:`, fetchError); 
        if (fetchError.code === 50001 || fetchError.code === 10003) {
             console.log(`‚ö†Ô∏è ${getLogTime()} - Bu sunucudaki hata token deƒüi≈üimi gerektirmeyebilir (izin eksikliƒüi).`); 
        } else {
            console.error(`‚ùå ${getLogTime()} - Bilinmeyen bir kritik hata. Mevcut tokeni √ß√∂pe ta≈üƒ±nƒ±yor ve bir sonraki tokene ge√ßiliyor.`); 
            moveTokenToTrash(currentBotToken);
            switchToNextToken();
        }
    }
}


function switchToNextToken() {
    currentTokenIndex++;
    if (currentTokenIndex < tokens.length) {
        console.log(`‚û°Ô∏è ${getLogTime()} - Bir sonraki tokene ge√ßiliyor... (${currentTokenIndex + 1}/${tokens.length})`); 
        if (client && typeof client.destroy === 'function') {
            client.destroy();
        }
        loginAndRunBot(tokens[currentTokenIndex]);
    } else {
        console.error(`üõë ${getLogTime()} - T√ºm tokenler denendi veya t√ºketildi. Program sonlandƒ±rƒ±lƒ±yor.`); 
        process.exit(0);
    }
}

loadConfig();
loadTokens();


if (tokens.length > 0) {
    loginAndRunBot(tokens[currentTokenIndex]);
} else {
    console.error(`‚ùå ${getLogTime()} - Y√ºklenecek token bulunamadƒ±. Program ba≈ülatƒ±lamadƒ±.`); 
    process.exit(1);
}